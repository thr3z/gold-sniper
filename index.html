<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XAU/USD Sniper Pro (Gemini Exchange Edition)</title>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-panel: #1e293b;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --accent: #fbbf24; /* Gold */
            --buy: #10b981;    /* Emerald Green */
            --sell: #ef4444;   /* Red */
            --wait: #64748b;
            --border: #334155;
        }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg-dark); color: var(--text-main); margin: 0; padding: 20px; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; }
        h1, h2, h3 { margin: 0 0 10px 0; color: var(--accent); letter-spacing: -0.5px; }
        
        .container { display: grid; grid-template-columns: 320px 1fr; gap: 20px; height: 100%; min-height: 0; }
        .sidebar { background: var(--bg-panel); padding: 20px; border-radius: 12px; overflow-y: auto; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 15px;}
        .main-content { display: flex; flex-direction: column; gap: 20px; overflow-y: auto; min-height: 0; }
        
        .panel { background: var(--bg-panel); padding: 20px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        /* Inputs */
        label { display: block; margin-bottom: 5px; font-size: 0.85em; color: var(--text-muted); font-weight: 600; }
        input, select { width: 100%; padding: 10px; background: #0f172a; border: 1px solid var(--border); color: white; border-radius: 6px; box-sizing: border-box; font-family: inherit;}
        input:focus { border-color: var(--accent); outline: none; }
        
        /* Buttons */
        button.action-btn { width: 100%; padding: 12px; background: var(--accent); color: #000; border: none; font-weight: 700; cursor: pointer; border-radius: 6px; transition: 0.2s; text-transform: uppercase; letter-spacing: 0.5px; }
        button.action-btn:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .tabs { display: flex; gap: 10px; margin-bottom: 10px; }
        .tab-btn { flex: 1; background: var(--bg-panel); border: 1px solid var(--border); color: var(--text-muted); padding: 10px; cursor: pointer; border-radius: 6px; font-weight: 600; }
        .tab-btn.active { background: var(--accent); color: #000; border-color: var(--accent); }

        /* Metrics */
        .metrics-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .metric-card { background: var(--bg-panel); padding: 15px; border-radius: 8px; border: 1px solid var(--border); }
        .metric-label { font-size: 0.8em; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
        .metric-val { font-size: 1.5em; font-weight: 800; margin-top: 5px; }
        
        /* Signal Box */
        .signal-box { border: 2px solid var(--border); padding: 20px; border-radius: 8px; text-align: center; background: rgba(0,0,0,0.2); transition: 0.3s; }
        .signal-box.buy { border-color: var(--buy); background: rgba(16, 185, 129, 0.1); }
        .signal-box.sell { border-color: var(--sell); background: rgba(239, 68, 68, 0.1); }
        .signal-large { font-size: 2.5em; font-weight: 900; margin: 10px 0; }
        
        .hidden { display: none !important; }
        
        /* Analysis Scorecard */
        .score-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #333; font-size: 0.9em; }
        .score-pass { color: var(--buy); }
        .score-fail { color: var(--sell); }

        /* Warning Badge */
        .badge-warning { background: #7f1d1d; color: #fca5a5; padding: 4px 8px; border-radius: 4px; font-size: 0.75em; font-weight: bold; display: inline-block; margin-bottom: 10px;}
    </style>
</head>
<body>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
        <div style="display:flex; align-items:center; gap: 10px;">
            <h1>XAU/USD Sniper Pro</h1>
            <span class="badge-warning">DAY TRADING EDITION</span>
        </div>
        <div id="connection-status" style="color: var(--text-muted); font-size: 0.8em; font-weight:bold;">● OFFLINE</div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('live')">Live Analysis</button>
        <button class="tab-btn" onclick="switchTab('backtest')">Backtest Strategy</button>
    </div>

    <div class="container" id="live-view">
        <aside class="sidebar">
            <div>
                <h3>1. Price Feed</h3>
                <label>Source Type</label>
                <select id="source-type" onchange="toggleSourceSettings()">
                    <option value="manual">Manual / Paste</option>
                    <option value="gemini">Gemini Exchange (Free)</option>
                    <option value="goldapi">GoldAPI.io (Live)</option>
                    <option value="alphavantage">AlphaVantage (Free Tier)</option>
                    <option value="custom_rest">Custom REST API</option>
                    <option value="websocket">WebSocket Stream</option>
                    <option value="simulated">Simulated Market (Demo)</option>
                </select>

                <!-- MANUAL INPUT -->
                <div id="set-manual" class="settings-group" style="margin-top:10px;">
                    <label>Current Price ($)</label>
                    <input type="number" id="manual-price" step="0.01" value="2000.00">
                    <button class="action-btn" onclick="manualUpdate()" style="margin-top:10px;">Update Analysis</button>
                </div>

                <!-- GEMINI EXCHANGE INPUT -->
                <div id="set-gemini" class="settings-group hidden" style="margin-top:10px;">
                    <div style="font-size:0.8em; color:#a0a0a0; margin-bottom:10px;">
                        Connects to Gemini.com API for PAXG/USD (Gold Token). No Key Required.
                    </div>
                    <button class="action-btn" onclick="startGemini()" style="margin-top:5px; background: #00bcd4; color:white;">Connect Gemini</button>
                </div>

                <!-- GOLD API INPUT -->
                <div id="set-goldapi" class="settings-group hidden" style="margin-top:10px;">
                    <label>GoldAPI.io Key</label>
                    <input type="password" id="goldapi-key" placeholder="Paste API Key Here">
                    <div style="font-size:0.75em; color:orange; margin-top:5px;">Polls every 60s to save limits.</div>
                    <button class="action-btn" onclick="startGoldApi()" style="margin-top:10px;">Connect GoldAPI</button>
                </div>

                <!-- ALPHAVANTAGE INPUT -->
                <div id="set-alphavantage" class="settings-group hidden" style="margin-top:10px;">
                    <label>AlphaVantage Key</label>
                    <input type="password" id="av-key" placeholder="Paste AV Key">
                    <div style="font-size:0.75em; color:orange; margin-top:5px;">Note: Free tier has daily limits.</div>
                    <button class="action-btn" onclick="startAlphaVantage()" style="margin-top:10px;">Connect AV</button>
                </div>

                <!-- CUSTOM REST INPUT -->
                <div id="set-custom_rest" class="settings-group hidden" style="margin-top:10px;">
                    <label>API URL</label>
                    <input type="text" id="cust-url" value="https://api.binance.com/api/v3/ticker/price?symbol=PAXGUSDT">
                    <div style="font-size:0.7em; color:gray; margin-bottom:5px">Default: Binance PAXG (Free, No Key)</div>
                    <label>JSON Path to Price</label>
                    <input type="text" id="cust-path" value="price">
                    <button class="action-btn" onclick="startCustomRest()" style="margin-top:10px;">Connect Custom</button>
                </div>

                <!-- WEBSOCKET INPUT -->
                <div id="set-ws" class="settings-group hidden" style="margin-top:10px;">
                    <label>WS URL</label>
                    <input type="text" id="ws-url" value="wss://stream.binance.com:9443/ws/xauusdt@trade">
                    <label>JSON Path (e.g. p)</label>
                    <input type="text" id="ws-path" value="p">
                    <button class="action-btn" onclick="connectWS()" style="margin-top:10px;">Connect Stream</button>
                </div>
            </div>

            <hr style="border-color: var(--border); width:100%;">

            <div>
                <h3>2. Historical Context</h3>
                <p style="font-size:0.8em; color:var(--text-muted);">Required for high accuracy (EMAs/RSI need history).</p>
                <input type="file" id="csv-upload" accept=".csv" onchange="handleFileUpload(this)">
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <button class="action-btn" style="background: #334155; color:white; font-size:0.8em;" onclick="loadSimulationData()">Reset Data</button>
                </div>
            </div>
            
            <div style="margin-top:auto">
                <button class="action-btn" style="background: #0f172a; border: 1px solid var(--accent); color: var(--accent);" onclick="exportTrade()">Export Plan</button>
            </div>
        </aside>

        <main class="main-content">
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Current Price</div>
                    <div class="metric-val" id="disp-price">---</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Trend (EMA)</div>
                    <div class="metric-val" id="disp-trend">---</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">RSI (14)</div>
                    <div class="metric-val" id="disp-rsi">---</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Accuracy Score</div>
                    <div class="metric-val" id="disp-conf">---</div>
                </div>
            </div>

            <div class="panel" style="flex: 2; min-height: 400px; position: relative;">
                <div id="chart-div" style="width:100%; height:100%;"></div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="panel">
                    <h3>AI Trade Call</h3>
                    <div id="signal-container" class="signal-box">
                        <div style="font-size:0.9em; letter-spacing:1px; color:var(--text-muted)">RECOMMENDED ACTION</div>
                        <div id="signal-direction" class="signal-large">WAIT</div>
                        <div id="signal-levels" class="hidden">
                            <div style="display:flex; justify-content:space-between; margin-top:10px; font-weight:bold;">
                                <span>Entry: <span id="sig-entry" style="color:white"></span></span>
                                <span>RR: <span id="sig-rr" style="color:var(--accent)">1:2</span></span>
                            </div>
                            <div style="display:flex; justify-content:space-between; margin-top:5px; font-size:0.9em;">
                                <span style="color:var(--sell)">SL: <span id="sig-sl"></span></span>
                                <span style="color:var(--buy)">TP: <span id="sig-tp"></span></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <h3>Confluence Scorecard</h3>
                    <div id="scorecard">
                        <div class="score-row"><span>Trend Alignment (EMA 20/50/200)</span><span style="color:#64748b">--</span></div>
                        <div class="score-row"><span>Momentum (MACD)</span><span style="color:#64748b">--</span></div>
                        <div class="score-row"><span>RSI Condition</span><span style="color:#64748b">--</span></div>
                        <div class="score-row"><span>Volatility (ATR)</span><span style="color:#64748b">--</span></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="container hidden" id="backtest-view">
        <aside class="sidebar">
            <h3>Backtest Config</h3>
            <label>Start Balance</label>
            <input type="number" id="bt-balance" value="10000">
            <label>Risk Per Trade (%)</label>
            <input type="number" id="bt-risk" value="2.0">
            <p style="font-size:0.8em; color:gray">Strict 90% logic results in fewer trades but fewer losses.</p>
            <input type="file" id="bt-csv-upload" accept=".csv">
            <button class="action-btn" onclick="runBacktest()">Run Simulation</button>
        </aside>
        <main class="main-content">
            <div class="panel">
                <h3>Strategy Performance</h3>
                <div class="metrics-grid">
                    <div class="metric-card"><div class="metric-label">Win Rate</div><div class="metric-val" id="bt-winrate">-</div></div>
                    <div class="metric-card"><div class="metric-label">Profit Factor</div><div class="metric-val" id="bt-pf">-</div></div>
                    <div class="metric-card"><div class="metric-label">Net Profit</div><div class="metric-val" id="bt-net">-</div></div>
                    <div class="metric-card"><div class="metric-label">Max Drawdown</div><div class="metric-val" id="bt-dd">-</div></div>
                </div>
            </div>
            <div class="panel" style="flex:1">
                <div id="bt-chart" style="width:100%; height:100%;"></div>
            </div>
        </main>
    </div>

<script>
    // --- ENGINE CORE ---
    let data = [];
    let currentPrice = 0;
    let wsConnection = null;
    let pollInterval = null;

    // --- INDICATORS ---
    const EMA = (arr, period) => {
        let results = [];
        const k = 2 / (period + 1);
        let ema = arr[0].close;
        results.push(ema);
        for (let i = 1; i < arr.length; i++) {
            ema = (arr[i].close * k) + (ema * (1 - k));
            results.push(ema);
        }
        return results;
    };

    const RSI = (arr, period) => {
        let results = [];
        let gains = 0, losses = 0;
        for(let i=1; i<=period; i++) {
            let diff = arr[i].close - arr[i-1].close;
            if(diff > 0) gains += diff; else losses += Math.abs(diff);
        }
        let avgGain = gains / period;
        let avgLoss = losses / period;
        for(let i=0; i<period; i++) results.push(null);
        results.push(100 - (100 / (1 + avgGain/avgLoss)));
        for(let i=period+1; i<arr.length; i++) {
            let diff = arr[i].close - arr[i-1].close;
            let gain = diff > 0 ? diff : 0;
            let loss = diff < 0 ? Math.abs(diff) : 0;
            avgGain = ((avgGain * (period-1)) + gain) / period;
            avgLoss = ((avgLoss * (period-1)) + loss) / period;
            let rs = avgGain / avgLoss;
            results.push(100 - (100 / (1 + rs)));
        }
        return results;
    };

    const MACD = (arr) => {
        const ema12 = EMA(arr, 12);
        const ema26 = EMA(arr, 26);
        let macdLine = [];
        for(let i=0; i<arr.length; i++) macdLine.push(ema12[i] - ema26[i]);
        const signalLine = [];
        const k = 2 / (9 + 1);
        let ema = macdLine[0];
        signalLine.push(ema);
        for(let i=1; i<macdLine.length; i++) {
            ema = (macdLine[i] * k) + (ema * (1 - k));
            signalLine.push(ema);
        }
        return { macd: macdLine, signal: signalLine, hist: macdLine.map((v,i) => v - signalLine[i]) };
    };

    const ATR = (arr, period) => {
        let trs = [];
        for(let i=0; i<arr.length; i++) {
            if(i===0) { trs.push(arr[i].high - arr[i].low); continue; }
            trs.push(Math.max(
                arr[i].high - arr[i].low,
                Math.abs(arr[i].high - arr[i-1].close),
                Math.abs(arr[i].low - arr[i-1].close)
            ));
        }
        let atrs = [];
        let sum = 0;
        for(let i=0; i<arr.length; i++) {
            if(i < period) { sum += trs[i]; atrs.push(sum/(i+1)); }
            else {
                let val = ((atrs[i-1] * (period-1)) + trs[i]) / period;
                atrs.push(val);
            }
        }
        return atrs;
    };

    // --- DATA HANDLING ---
    function init() { loadSimulationData(); }

    function loadSimulationData() {
        data = [];
        let price = 2000;
        let now = new Date();
        now.setDate(now.getDate() - 20); 
        for(let i=0; i<1000; i++) {
            now.setMinutes(now.getMinutes() + 15);
            let move = (Math.random() - 0.49) * 3; 
            let open = price;
            price += move;
            let close = price;
            let high = Math.max(open, close) + Math.random();
            let low = Math.min(open, close) - Math.random();
            data.push({ time: now.toISOString(), open, high, low, close });
        }
        currentPrice = data[data.length-1].close;
        updateEngine();
    }

    function handleFileUpload(input) {
        Papa.parse(input.files[0], {
            header: true, dynamicTyping: true, skipEmptyLines: true,
            complete: (res) => {
                const mapRow = r => {
                    const find = k => r[Object.keys(r).find(key => key.toLowerCase().includes(k))];
                    return { time: find('date')||find('time'), open: find('open'), high: find('high'), low: find('low'), close: find('close') };
                };
                const clean = res.data.map(mapRow).filter(r => r.close && r.time);
                if(clean.length > 100) { data = clean; currentPrice = data[data.length-1].close; updateEngine(); }
                else alert("CSV needs Date, Open, High, Low, Close");
            }
        });
    }

    // --- STRATEGY ENGINE ---
    function analyzeMarket(history) {
        const i = history.length - 1;
        const ema20 = EMA(history, 20);
        const ema50 = EMA(history, 50);
        const ema200 = EMA(history, 200);
        const rsi = RSI(history, 14);
        const macd = MACD(history);
        const atr = ATR(history, 14)[i];

        const c = history[i].close;
        const e20 = ema20[i];
        const e50 = ema50[i];
        const e200 = ema200[i];
        const r = rsi[i];
        const mHist = macd.hist[i];
        const mHistPrev = macd.hist[i-1];

        let score = 0;
        let reasons = [];
        let bias = "NEUTRAL";

        if(e20 > e50 && e50 > e200) {
            score += 30; bias = "BULLISH";
            reasons.push({text: "Strong Uptrend (EMA 20>50>200)", pass: true});
        } else if(e20 < e50 && e50 < e200) {
            score += 30; bias = "BEARISH";
            reasons.push({text: "Strong Downtrend (EMA 20<50<200)", pass: true});
        } else {
            reasons.push({text: "Choppy Market (EMAs Mixed)", pass: false});
        }

        if(bias === "BULLISH") {
            if(r > 40 && r < 70) { score += 15; reasons.push({text: "RSI Healthy (40-70)", pass: true}); }
            else reasons.push({text: `RSI Warning (${r.toFixed(1)})`, pass: false});
            if(mHist > 0 && mHist > mHistPrev) { score += 15; reasons.push({text: "MACD Expanding Up", pass: true}); }
            else reasons.push({text: "MACD Weak", pass: false});
        } 
        else if (bias === "BEARISH") {
            if(r < 60 && r > 30) { score += 15; reasons.push({text: "RSI Healthy (30-60)", pass: true}); }
            else reasons.push({text: `RSI Warning (${r.toFixed(1)})`, pass: false});
            if(mHist < 0 && mHist < mHistPrev) { score += 15; reasons.push({text: "MACD Expanding Down", pass: true}); }
            else reasons.push({text: "MACD Weak", pass: false});
        }

        const distToEma20 = Math.abs(c - e20);
        if(distToEma20 < atr * 1.5) {
            score += 20;
            reasons.push({text: "Price in Value Zone (Near EMA20)", pass: true});
        } else {
            reasons.push({text: "Price Extended (Wait for Pullback)", pass: false});
        }

        if(atr > 1.0) { 
            score += 20;
            reasons.push({text: "Volatility Sufficient", pass: true});
        } else {
            reasons.push({text: "Low Volatility", pass: false});
        }

        let signal = "WAIT";
        if(score >= 85) signal = bias === "BULLISH" ? "BUY" : "SELL";

        const slDist = atr * 1.5; 
        const tpDist = atr * 3.0; 
        
        return { 
            signal, score, reasons, atr, 
            entry: c, 
            sl: signal==="BUY" ? c - slDist : c + slDist,
            tp: signal==="BUY" ? c + tpDist : c - tpDist,
            ema20Series: ema20, ema50Series: ema50, trend: bias, rsi: r
        };
    }

    function updateEngine() {
        if(data.length < 200) return;
        
        let last = data[data.length-1];
        last.close = currentPrice; 
        if(currentPrice > last.high) last.high = currentPrice;
        if(currentPrice < last.low) last.low = currentPrice;

        const res = analyzeMarket(data);

        document.getElementById('disp-price').innerText = currentPrice.toFixed(2);
        document.getElementById('disp-trend').innerText = res.trend;
        document.getElementById('disp-rsi').innerText = res.rsi.toFixed(1);
        document.getElementById('disp-conf').innerText = res.score + "%";
        document.getElementById('disp-conf').style.color = res.score >= 85 ? "var(--buy)" : "var(--text-muted)";

        const scHtml = res.reasons.map(r => 
            `<div class="score-row"><span>${r.text}</span><span class="${r.pass?'score-pass':'score-fail'}">${r.pass?'✔':'✘'}</span></div>`
        ).join('');
        document.getElementById('scorecard').innerHTML = scHtml;

        const sigBox = document.getElementById('signal-container');
        const sigDir = document.getElementById('signal-direction');
        const sigLvls = document.getElementById('signal-levels');
        
        sigDir.innerText = res.signal;
        sigBox.className = `signal-box ${res.signal.toLowerCase()}`;
        
        if(res.signal !== "WAIT") {
            sigLvls.classList.remove('hidden');
            document.getElementById('sig-entry').innerText = res.entry.toFixed(2);
            document.getElementById('sig-sl').innerText = res.sl.toFixed(2);
            document.getElementById('sig-tp').innerText = res.tp.toFixed(2);
        } else {
            sigLvls.classList.add('hidden');
        }

        const traceCandle = {
            x: data.map(d=>d.time), 
            close: data.map(d=>d.close), 
            high: data.map(d=>d.high), 
            low: data.map(d=>d.low), 
            open: data.map(d=>d.open), 
            type: 'candlestick', name: 'Price',
            decreasing: {line: {color: '#ef4444'}}, increasing: {line: {color: '#10b981'}}
        };
        const trace20 = { x: data.map(d=>d.time), y: res.ema20Series, type: 'scatter', mode: 'lines', line: {color: 'cyan', width: 1}, name: 'EMA 20' };
        const trace50 = { x: data.map(d=>d.time), y: res.ema50Series, type: 'scatter', mode: 'lines', line: {color: 'orange', width: 1}, name: 'EMA 50' };

        const layout = {
            dragmode: 'pan', showlegend: false,
            xaxis: { type: 'date', gridcolor: '#334155' },
            yaxis: { gridcolor: '#334155' },
            paper_bgcolor: '#1e293b', plot_bgcolor: '#1e293b',
            font: { color: '#f1f5f9' },
            margin: {r:30, t:20, b:30, l:50},
            shapes: []
        };

        if(res.signal !== "WAIT") {
             const line = (y, c) => ({ type: 'line', x0: data[data.length-10].time, x1: data[data.length-1].time, y0: y, y1: y, line: {color: c, width: 2, dash: 'dot'} });
             layout.shapes.push(line(res.entry, 'white'));
             layout.shapes.push(line(res.sl, '#ef4444'));
             layout.shapes.push(line(res.tp, '#10b981'));
        }

        Plotly.react('chart-div', [traceCandle, trace20, trace50], layout);
    }

    // --- UTILS & CONNECTIVITY ---
    function manualUpdate() {
        currentPrice = parseFloat(document.getElementById('manual-price').value);
        updateEngine();
    }
    
    // Gemini Exchange
    function startGemini() {
        if(pollInterval) clearInterval(pollInterval);
        if(wsConnection) wsConnection.close();
        
        const fetchPrice = async () => {
            try {
                // Gemini PAXG/USD Ticker
                const response = await fetch('https://api.gemini.com/v1/pubticker/paxgusd');
                const json = await response.json();
                if(json.last) {
                    currentPrice = parseFloat(json.last);
                    updateEngine();
                    document.getElementById('connection-status').innerHTML = "● LIVE (GEMINI)";
                    document.getElementById('connection-status').style.color = "#00bcd4";
                }
            } catch(e) {
                document.getElementById('connection-status').innerHTML = "● API ERROR";
                document.getElementById('connection-status').style.color = "#ef4444";
            }
        };
        fetchPrice();
        pollInterval = setInterval(fetchPrice, 10000); // 10s poll
    }

    function startGoldApi() {
        const key = document.getElementById('goldapi-key').value;
        if(!key) { alert("Please enter API Key"); return; }
        
        if(pollInterval) clearInterval(pollInterval);
        if(wsConnection) wsConnection.close();

        const fetchPrice = async () => {
            try {
                // GoldAPI Endpoint for XAU/USD
                const response = await fetch('https://www.goldapi.io/api/XAU/USD', {
                    headers: { 'x-access-token': key, 'Content-Type': 'application/json' }
                });
                if(!response.ok) throw new Error("API Limit or Key Error");
                const json = await response.json();
                
                if(json.price) {
                    currentPrice = parseFloat(json.price);
                    updateEngine();
                    document.getElementById('connection-status').innerHTML = "● ONLINE (GoldAPI)";
                    document.getElementById('connection-status').style.color = "#10b981";
                }
            } catch(e) {
                document.getElementById('connection-status').innerHTML = "● API ERROR";
                document.getElementById('connection-status').style.color = "#ef4444";
                console.error(e);
            }
        };

        fetchPrice(); // Initial call
        pollInterval = setInterval(fetchPrice, 60000); // Poll every 60 seconds
    }

    // AlphaVantage
    function startAlphaVantage() {
        const key = document.getElementById('av-key').value;
        if(!key) { alert("Enter AlphaVantage Key"); return; }
        
        if(pollInterval) clearInterval(pollInterval);
        if(wsConnection) wsConnection.close();

        const fetchPrice = async () => {
            try {
                const url = `https://www.alphavantage.co/query?function=CURRENCY_EXCHANGE_RATE&from_currency=XAU&to_currency=USD&apikey=${key}`;
                const response = await fetch(url);
                const json = await response.json();
                // AlphaVantage Structure: "Realtime Currency Exchange Rate" -> "5. Exchange Rate"
                const rate = json["Realtime Currency Exchange Rate"]?.["5. Exchange Rate"];
                
                if(rate) {
                    currentPrice = parseFloat(rate);
                    updateEngine();
                    document.getElementById('connection-status').innerHTML = "● ONLINE (AV)";
                    document.getElementById('connection-status').style.color = "#10b981";
                } else { throw new Error("Limit reached"); }
            } catch(e) {
                document.getElementById('connection-status').innerHTML = "● AV LIMIT/ERR";
                document.getElementById('connection-status').style.color = "#ef4444";
            }
        };
        fetchPrice();
        // AlphaVantage free tier is very limited (25/day approx). Polling every 60s will kill it in 25 mins.
        // We'll set it to 5 minutes to be safe-ish, but warn user.
        pollInterval = setInterval(fetchPrice, 300000); 
    }

    // Custom REST
    function startCustomRest() {
        const url = document.getElementById('cust-url').value;
        const path = document.getElementById('cust-path').value;
        
        if(pollInterval) clearInterval(pollInterval);
        if(wsConnection) wsConnection.close();

        const fetchPrice = async () => {
            try {
                const response = await fetch(url);
                const json = await response.json();
                // Helper to get nested path
                const val = path.split('.').reduce((o,i)=>o?.[i], json);
                
                if(val) {
                    currentPrice = parseFloat(val);
                    updateEngine();
                    document.getElementById('connection-status').innerHTML = "● ONLINE (Custom)";
                    document.getElementById('connection-status').style.color = "#10b981";
                }
            } catch(e) {
                document.getElementById('connection-status').innerHTML = "● FETCH ERR";
                document.getElementById('connection-status').style.color = "#ef4444";
            }
        };
        fetchPrice();
        pollInterval = setInterval(fetchPrice, 10000); // Poll every 10s
    }

    function connectWS() {
        const url = document.getElementById('ws-url').value;
        const path = document.getElementById('ws-path').value;
        if(pollInterval) clearInterval(pollInterval);
        try {
            if(wsConnection) wsConnection.close();
            wsConnection = new WebSocket(url);
            wsConnection.onopen = () => {
                document.getElementById('connection-status').innerHTML = "● LIVE STREAM";
                document.getElementById('connection-status').style.color = "#10b981";
            };
            wsConnection.onmessage = (e) => {
                const msg = JSON.parse(e.data);
                const p = path === 'p' ? msg.p : msg[path]; 
                if(p) {
                    currentPrice = parseFloat(p);
                    updateEngine();
                }
            };
        } catch(e) { alert("WS Error"); }
    }

    function toggleSourceSettings() {
        document.getElementById('set-manual').classList.add('hidden');
        document.getElementById('set-gemini').classList.add('hidden');
        document.getElementById('set-goldapi').classList.add('hidden');
        document.getElementById('set-alphavantage').classList.add('hidden');
        document.getElementById('set-custom_rest').classList.add('hidden');
        document.getElementById('set-ws').classList.add('hidden');
        
        const val = document.getElementById('source-type').value;
        if(val === 'manual') document.getElementById('set-manual').classList.remove('hidden');
        if(val === 'gemini') document.getElementById('set-gemini').classList.remove('hidden');
        if(val === 'goldapi') document.getElementById('set-goldapi').classList.remove('hidden');
        if(val === 'alphavantage') document.getElementById('set-alphavantage').classList.remove('hidden');
        if(val === 'custom_rest') document.getElementById('set-custom_rest').classList.remove('hidden');
        if(val === 'websocket') document.getElementById('set-ws').classList.remove('hidden');
        
        // Reset connections
        if(pollInterval) clearInterval(pollInterval);
        if(wsConnection) wsConnection.close();
        if(val === 'simulated') loadSimulationData();
        
        document.getElementById('connection-status').innerHTML = "● WAITING...";
        document.getElementById('connection-status').style.color = "#64748b";
    }

    function switchTab(t) {
        document.getElementById('live-view').classList.add('hidden');
        document.getElementById('backtest-view').classList.add('hidden');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        
        if(t === 'live') {
            document.getElementById('live-view').classList.remove('hidden');
            document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
        } else {
            document.getElementById('backtest-view').classList.remove('hidden');
            document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
        }
    }

    // --- BACKTESTER ---
    function runBacktest() {
        if(data.length < 500) { alert("Need more data (upload CSV)"); return; }
        
        let balance = parseFloat(document.getElementById('bt-balance').value);
        const riskPct = parseFloat(document.getElementById('bt-risk').value) / 100;
        
        let equity = [];
        let trades = [];
        let position = null; 
        
        const ema20 = EMA(data, 20);
        const ema50 = EMA(data, 50);
        const ema200 = EMA(data, 200);
        const rsi = RSI(data, 14);
        const atrs = ATR(data, 14);
        const macd = MACD(data);

        for(let i=200; i<data.length; i++) {
            const c = data[i];
            
            if(position) {
                let pnl = 0;
                let closePos = false;
                
                if(position.type === 'BUY') {
                    if(c.low <= position.sl) { pnl = (position.sl - position.entry) * position.size; closePos = true; }
                    else if(c.high >= position.tp) { pnl = (position.tp - position.entry) * position.size; closePos = true; }
                } else {
                    if(c.high >= position.sl) { pnl = (position.entry - position.sl) * position.size; closePos = true; }
                    else if(c.low <= position.tp) { pnl = (position.entry - position.tp) * position.size; closePos = true; }
                }

                if(closePos) {
                    balance += pnl;
                    trades.push(pnl);
                    position = null;
                }
            }

            if(!position) {
                const e20v = ema20[i]; const e50v = ema50[i]; const e200v = ema200[i];
                const rv = rsi[i]; const mh = macd.hist[i]; const mhp = macd.hist[i-1];
                const atrv = atrs[i];
                
                let score = 0;
                let bias = "";
                
                if(e20v > e50v && e50v > e200v) { score += 30; bias="BUY"; }
                else if(e20v < e50v && e50v < e200v) { score += 30; bias="SELL"; }
                
                if(bias === "BUY") {
                    if(rv > 40 && rv < 70) score += 15;
                    if(mh > 0 && mh > mhp) score += 15;
                    if(Math.abs(c.close - e20v) < atrv * 1.5) score += 20;
                } else if (bias === "SELL") {
                    if(rv < 60 && rv > 30) score += 15;
                    if(mh < 0 && mh < mhp) score += 15;
                    if(Math.abs(c.close - e20v) < atrv * 1.5) score += 20;
                }
                
                if(atrv > 1.0) score += 20;

                if(score >= 85) {
                    const slDist = atrv * 1.5;
                    const tpDist = atrv * 3.0;
                    const riskAmt = balance * riskPct;
                    const size = riskAmt / slDist; 
                    
                    position = {
                        type: bias,
                        entry: c.close,
                        sl: bias==="BUY" ? c.close - slDist : c.close + slDist,
                        tp: bias==="BUY" ? c.close + tpDist : c.close - tpDist,
                        size: size
                    };
                }
            }
            equity.push({t: c.time, b: balance});
        }

        const wins = trades.filter(p => p > 0).length;
        const total = trades.length;
        const winrate = total ? ((wins/total)*100).toFixed(1) + '%' : '0%';
        const net = balance - parseFloat(document.getElementById('bt-balance').value);
        
        let peak = -Infinity;
        let maxDD = 0;
        equity.forEach(e => {
            if(e.b > peak) peak = e.b;
            let dd = (peak - e.b) / peak;
            if(dd > maxDD) maxDD = dd;
        });

        document.getElementById('bt-winrate').innerText = winrate;
        document.getElementById('bt-net').innerText = "$" + net.toFixed(2);
        document.getElementById('bt-dd').innerText = (maxDD*100).toFixed(1) + "%";
        document.getElementById('bt-pf').innerText = trades.length > 0 ? (trades.filter(x=>x>0).reduce((a,b)=>a+b,0) / Math.abs(trades.filter(x=>x<0).reduce((a,b)=>a+b,0) || 1)).toFixed(2) : "-";

        Plotly.newPlot('bt-chart', [{
            x: equity.map(e=>e.t), y: equity.map(e=>e.b),
            type: 'scatter', mode: 'lines', line: {color: '#fbbf24'}, fill: 'tozeroy'
        }], {
            title: 'Equity Curve', paper_bgcolor: '#1e293b', plot_bgcolor: '#1e293b',
            font: {color: '#ccc'}, margin: {t:30, l:40, r:20, b:30}
        });
    }

    init();
</script>
</body>
</html>
